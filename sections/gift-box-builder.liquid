<div class="custom-box-section page-width">

  <!-- Step Indicator -->
  <div class="step-indicator">
  <div class="step active" data-step="0">
    <span class="step-number">1</span> <span>Choose Products</span>
  </div>
  <div class="step" data-step="1">
    <span class="step-number">2</span> <span>Choose Gift Box</span>
  </div>
  <div class="step" data-step="2">
    <span class="step-number">3</span> <span>Confirm Box</span>
  </div>
</div>

<div class="custom-gift-box-section">
  
  <!-- Left Side: Filter Sidebar -->
  <div class="filter-sidebar">
    <h3>Filter:</h3>
    
    <!-- Category Filter -->
    <div class="filter-group">
      <h4>Category:</h4>
      <div class="category-list">
        {% for block in section.blocks %}
          {% if block.type == 'collection' %}
            {% assign selected_collection = collections[block.settings.collection] %}
            {% if selected_collection and selected_collection.products.size > 0 %}
              <label class="category-item">
                <input type="checkbox" class="category-checkbox" data-handle="{{ selected_collection.handle }}"> 
                {{ selected_collection.title }}
              </label>
            {% endif %}
          {% endif %}
        {% endfor %}
        <label class="category-item">
          <input type="checkbox" class="category-checkbox" data-handle="all" checked> All Products
        </label>
      </div>
    </div>

    <!-- Availability Filter -->
    <div class="filter-group cmb-Availability">
      <h4>Availability:</h4>
      <div class="availability-list">
        <label class="availability-item">
          <input type="checkbox" id="in-stock" checked> In stock (<span id="in-stock-count">0</span>)
        </label>
        <label class="availability-item">
          <input type="checkbox" id="out-of-stock"> Out of stock (<span id="out-stock-count">0</span>)
        </label>
      </div>
    </div>

    <!-- Price Range Filter -->
    <div class="filter-group cmb-Price">
      <h4>Price:</h4>
      <p class="price-info">The highest price is à§³<span id="max-price">4,750</span></p>
      <div class="price-range">
        <div class="price-inputs">
          <input type="number" id="price-from" placeholder="From" min="0">
          <span>à§³</span>
          <input type="number" id="price-to" placeholder="To" min="0">
          <span>à§³</span>
        </div>
        <div class="price-slider-container">
          <input type="range" id="price-slider-min" min="0" max="5000" value="0" class="price-slider">
          <input type="range" id="price-slider-max" min="0" max="5000" value="5000" class="price-slider">
        </div>
        <div class="price-display">
          à§³<span id="price-range-display">0 - 4,750</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Right Side: Content Area -->
  <div class="content-area">
    
    <!-- Search + Sort Section -->
    <div class="search-sort-header">
      <div class="custom-search-wrapper">
        <input type="text" id="productSearch" placeholder="Search products..." autocomplete="off">
        <button type="submit" class="search-icon-button" aria-label="Search">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" width="20" height="20">
            <circle cx="11" cy="11" r="8" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            <line x1="21" y1="21" x2="16.65" y2="16.65" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </button>
        <div id="search-suggestions" class="suggestions-dropdown" style="display: none;"></div>
      </div>

      <select class="cmb-sortOptions" id="sortOptions">
        <option value="manual">Default (Manual Order)</option>
        <option value="best-selling">Best Selling</option>
        <option value="featured">Featured First</option>
        <option value="price-asc">Price low to high</option>
        <option value="price-desc">Price high to low</option>
        <option value="title-asc">Alphabetically A-Z</option>
      </select>
    </div>

    <!-- Step Content Sections -->
    <div class="step-content-wrapper">
      
      <!-- Product Grid Step -->
      <div id="product-step" class="step-section">
        <h2>Choose Products</h2>
        
        <!-- Featured/Best Selling Section -->
        <div id="showcase-section" class="showcase-section" style="display: none;">
          <h3 class="showcase-title">Featured Products</h3>
          <div id="showcaseGrid" class="product-grid showcase-grid"></div>
        </div>
        
        <div id="productGrid" class="product-grid">
          {% assign processed_products = '' %}
          {% assign product_index = 0 %}
          {% comment %} Loop through selected collections only {% endcomment %}
          {% for block in section.blocks %}
            {% if block.type == 'collection' %}
              {% assign selected_collection = collections[block.settings.collection] %}
              {% if selected_collection %}
                {% for product in selected_collection.products %}
                 {% if product.available %}
                   {% unless processed_products contains product.id %}
                     {% assign processed_products = processed_products | append: product.id | append: ',' %}
                     {% assign product_index = product_index | plus: 1 %}
                     
                     {% assign first_available_variant = null %}
                     {% for v in product.variants %}
                       {% if v.available and first_available_variant == null %}
                         {% assign first_available_variant = v %}
                       {% endif %}
                     {% endfor %}

                     {% comment %} Fixed price calculation {% endcomment %}
                     {% assign variant_price = first_available_variant.price | divided_by: 100.0 %}
                     {% assign variant_price_rounded = variant_price | round %}

                     {% assign is_featured = false %}
                     {% assign is_best_selling = false %}
                     {% assign product_position = 9999 %}
                     
                     {% for tag in product.tags %}
                       {% assign tag_lower = tag | downcase %}
                       {% if tag_lower == 'featured' %}
                         {% assign is_featured = true %}
                       {% endif %}
                       {% if tag_lower == 'best-selling' or tag_lower == 'best selling' %}
                         {% assign is_best_selling = true %}
                       {% endif %}
                       {% comment %} Check for position tag (format: position-1, position-2, etc.) {% endcomment %}
                       {% if tag_lower contains 'position-' %}
                         {% assign position_parts = tag_lower | split: '-' %}
                         {% if position_parts.size == 2 %}
                           {% assign product_position = position_parts[1] | plus: 0 %}
                         {% endif %}
                       {% endif %}
                     {% endfor %}
                     
                     <div class="product-card"
                        data-id="{{ first_available_variant.id }}"
                        data-product-id="{{ product.id }}"
                        data-title="{{ product.title | escape }} - {{ first_available_variant.title }}"
                        data-price="{{ variant_price_rounded }}"
                        data-collection="{{ selected_collection.handle }}"
                        data-options="{{ first_available_variant.options | join: ' / ' }}"
                        data-available="{{ product.available }}"
                        data-featured="{{ is_featured }}"
                        data-best-selling="{{ is_best_selling }}"
                        data-position="{{ product_position }}"
                        data-collection-index="{{ product_index }}">
                   
                       <!-- Badge for Stock Status / Featured / Best Selling -->
                       {% if product.available == false %}
                         <div class="product-badge outofstock-badge">Out of Stock</div>
                       {% elsif is_featured %}
                         <div class="product-badge featured-badge">Featured</div>
                       {% elsif is_best_selling %}
                         <div class="product-badge bestseller-badge">Best Seller</div>
                       {% endif %}
                       
                       <!-- Updated image element with data attribute for variant image -->
                       <img class="product-main-image" 
                            src="{% if first_available_variant.image %}{{ first_available_variant.image | img_url: '300x' }}{% else %}{{ product.featured_image | img_url: '300x' }}{% endif %}" 
                            alt="{{ product.title }}"
                            data-default-image="{{ product.featured_image | img_url: '300x' }}">
                       <p class="product-title">{{ product.title }}</p>
                       <p class="product-price">à§³{{ variant_price_rounded }}</p>
                   
                       {% comment %} Store all variants data for modal {% endcomment %}
                       {% if product.variants.size > 1 %}
                         <div class="product-variants-data" style="display: none;" data-variants='[
                           {% for variant in product.variants %}
                             {% assign variant_price_calc = variant.price | divided_by: 100.0 | round %}
                             {
                               "id": {{ variant.id }},
                               "title": "{{ variant.title | escape }}",
                               "price": {{ variant_price_calc }},
                               "image": "{% if variant.image %}{{ variant.image | img_url: '300x' }}{% else %}{{ product.featured_image | img_url: '300x' }}{% endif %}",
                               "options": {{ variant.options | json }},
                               "available": {{ variant.available }}
                             }{% unless forloop.last %},{% endunless %}
                           {% endfor %}
                         ]' data-options='{{ product.options_with_values | json }}'></div>
                       {% endif %}
                   
                       <button class="add-to-box-btn"
                         data-id="{{ first_available_variant.id }}"
                         data-title="{{ product.title | escape }} - {{ first_available_variant.title }}"
                         data-price="{{ variant_price_rounded }}"
                         data-image="{% if first_available_variant.image %}{{ first_available_variant.image | img_url: '200x' }}{% else %}{{ product.featured_image | img_url: '200x' }}{% endif %}"
                         data-has-variants="{{ product.variants.size | minus: 1 }}"
                         {% unless product.available %}disabled{% endunless %}>
                         {% if product.available %}Add +{% else %}Out of Stock{% endif %}
                       </button>
                   
                       <div class="cus-quantity-control" style="display: none;">
                         <button class="cus-qty-btn cus-decrease" data-id="{{ first_available_variant.id }}">-</button>
                         <span class="cus-qty">1</span>
                         <button class="cus-qty-btn cus-increase" data-id="{{ first_available_variant.id }}">Add +</button>
                       </div>
                     </div>
                   {% endunless %}
                 {% endif %}
                {% endfor %}
              {% endif %}
            {% endif %}
          {% endfor %}
          
          {% comment %} Always include gift-box collection (hardcoded exception) {% endcomment %}
          {% assign gift_box_collection = collections['gift-box'] %}
          {% if gift_box_collection %}
            {% for product in gift_box_collection.products %}
              {% if product.available %}
                {% unless processed_products contains product.id %}
                  {% assign processed_products = processed_products | append: product.id | append: ',' %}
                  
                  {% assign first_available_variant = null %}
                  {% for v in product.variants %}
                    {% if v.available and first_available_variant == null %}
                      {% assign first_available_variant = v %}
                    {% endif %}
                  {% endfor %}

                  {% assign variant_price = first_available_variant.price | divided_by: 100.0 %}
                  {% assign variant_price_rounded = variant_price | round %}

                  <div class="product-card"
                     data-id="{{ first_available_variant.id }}"
                     data-product-id="{{ product.id }}"
                     data-title="{{ product.title | escape }} - {{ first_available_variant.title }}"
                     data-price="{{ variant_price_rounded }}"
                     data-collection="gift-box"
                     data-options="{{ first_available_variant.options | join: ' / ' }}"
                     data-available="{{ product.available }}"
                     data-featured="false"
                     data-best-selling="false"
                     style="display: none;">
                
                    <img class="product-main-image" 
                         src="{% if first_available_variant.image %}{{ first_available_variant.image | img_url: '300x' }}{% else %}{{ product.featured_image | img_url: '300x' }}{% endif %}" 
                         alt="{{ product.title }}"
                         data-default-image="{{ product.featured_image | img_url: '300x' }}">
                    <p class="product-title">{{ product.title }}</p>
                    <p class="product-price">à§³{{ variant_price_rounded }}</p>
                
                    <button class="add-to-box-btn"
                      data-id="{{ first_available_variant.id }}"
                      data-title="{{ product.title | escape }} - {{ first_available_variant.title }}"
                      data-price="{{ variant_price_rounded }}"
                      data-image="{% if first_available_variant.image %}{{ first_available_variant.image | img_url: '200x' }}{% else %}{{ product.featured_image | img_url: '200x' }}{% endif %}">
                      Add +
                    </button>
                
                    <div class="cus-quantity-control" style="display: none;">
                      <button class="cus-qty-btn cus-decrease" data-id="{{ first_available_variant.id }}">-</button>
                      <span class="cus-qty">1</span>
                      <button class="cus-qty-btn cus-increase" data-id="{{ first_available_variant.id }}">Add +</button>
                    </div>
                  </div>
                {% endunless %}
              {% endif %}
            {% endfor %}
          {% endif %}
        </div>
      </div>

      <!-- Gift Box Step -->
      <div id="gift-box-step" class="step-section" style="display: none;">
        <h2>CHOOSE YOUR GIFT BOX</h2>
        <div id="giftBoxGrid" class="product-grid">
          {% assign gift_box_collection = collections['gift-box'] %}
          {% for product in gift_box_collection.products %}
            {% if product.available %}
              {% assign gift_price = product.price | divided_by: 100.0 | round %}
              <div class="product-card"
                 data-id="{{ product.variants.first.id }}"
                 data-title="{{ product.title | escape }}"
                 data-price="{{ gift_price }}"
                 data-collection="gift-box"
                 data-available="{{ product.available }}">
        
                <img src="{{ product.featured_image | img_url: '300x' }}" alt="{{ product.title }}">
                <p class="product-title">{{ product.title }}</p>
                <p class="product-price">à§³{{ gift_price }}</p>
                <button class="add-to-box-btn"
                  data-id="{{ product.variants.first.id }}"
                  data-title="{{ product.title | escape }}"
                  data-price="{{ gift_price }}"
                  data-image="{{ product.featured_image | img_url: '200x' }}">
                  Add +
                </button>
                <div class="cus-quantity-control" style="display: none;">
                <button class="cus-qty-btn cus-decrease" data-id="${product.id}">-</button>
                <span class="cus-qty">1</span>
                <button class="cus-qty-btn cus-increase" data-id="${product.id}">Add +</button>
                </div>
              </div>
            {% endif %}
          {% endfor %}
        </div>
      </div>

      <!-- Confirm Box Step -->
      <div id="confirm-box-step" class="step-section" style="display: none;">
        <h2>CONFIRM YOUR BOX</h2>
        <div id="confirmation-details"></div>
      </div>
    </div>
  </div>

  <!-- Mini Cart (Right Sidebar) -->
  <div class="your-box" id="mini-cart">
    <h3>YOUR BOX (<span id="box-count">0 ITEM</span>)</h3>
    <hr>
    <div id="box-items"></div>
    <p>Total: <span id="box-total" style="font-weight: bold;">à§³0</span></p>
    <button id="next-button" class="next-btn" disabled>Next</button>
    <p id="next-alert" style="color: red; font-size: 14px; margin-top: 6px; display: none;">
    Please select at least one product to continue.
    </p>
    <div id="box-items-button">
      <button id="back-button" class="back-btn">Back</button>
      <button id="confirm-button" class="confirm-btn" disabled>Next</button>
    </div>
    <div class="alert-row">
    <p id="confirm-inline-alert" style="color: red; font-size: 14px; display: none;">
        Please select a gift box before continuing.
    </p>
    </div>
    <div id="box-items-button">
    <button id="back-button-2" class="back-btn">Back</button>
    <button id="submit-button" class="confirm-btn">Submit Box</button>
    </div>
  </div>
</div>
</div>

<!-- Variant Selection Modal -->
<div id="variant-modal" class="variant-modal" style="display: none;">
  <div class="variant-modal-overlay"></div>
  <div class="variant-modal-content">
    <button class="variant-modal-close">&times;</button>
    <div class="variant-modal-body">
      <div class="variant-modal-image">
        <img id="modal-product-image" src="" alt="">
      </div>
      <div class="variant-modal-details">
        <h3 id="modal-product-title"></h3>
        <p class="modal-product-price" id="modal-product-price"></p>
        <div id="modal-variant-options"></div>
        <button id="modal-add-to-box" class="modal-add-btn">Add to Box</button>
      </div>
    </div>
  </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
$(document).ready(function () {
    // ==================== INITIAL SETUP ====================
    $('#next-button, #confirm-button, #back-button, #submit-button, #back-button-2').hide();
    showStep(0);

    let selectedProducts = JSON.parse(localStorage.getItem('selectedProducts')) || [];

    // ==================== FILTER INITIALIZATION ====================
    function initializeFilters() {
        updateAvailabilityCount();
        updateMaxPrice();
        setupPriceSliders();
    }

    function updateAvailabilityCount() {
        const inStockCount = $('.product-card[data-available="true"]:visible').length;
        const outStockCount = $('.product-card[data-available="false"]:visible').length;
        $('#in-stock-count').text(inStockCount);
        $('#out-stock-count').text(outStockCount);
    }

    function updateMaxPrice() {
        let maxPrice = 0;
        $('.product-card').each(function() {
            const price = parseInt($(this).data('price'));
            if (price > maxPrice) {
                maxPrice = price;
            }
        });
        $('#max-price').text(maxPrice.toLocaleString());
        $('#price-slider-max').attr('max', maxPrice).val(maxPrice);
        $('#price-to').attr('max', maxPrice).val(maxPrice);
        $('#price-range-display').text(`0 - ${maxPrice.toLocaleString()}`);
    }

    function setupPriceSliders() {
        const minSlider = document.getElementById('price-slider-min');
        const maxSlider = document.getElementById('price-slider-max');
        const minInput = document.getElementById('price-from');
        const maxInput = document.getElementById('price-to');

        function updatePriceRange() {
            const min = parseInt(minSlider.value);
            const max = parseInt(maxSlider.value);
            
            if (min >= max) {
                minSlider.value = max - 1;
            }
            
            minInput.value = minSlider.value;
            maxInput.value = maxSlider.value;
            $('#price-range-display').text(`${parseInt(minSlider.value).toLocaleString()} - ${parseInt(maxSlider.value).toLocaleString()}`);
            applyAllFilters();
        }

        minSlider.addEventListener('input', updatePriceRange);
        maxSlider.addEventListener('input', updatePriceRange);
        
        minInput.addEventListener('input', function() {
            minSlider.value = this.value;
            updatePriceRange();
        });
        
        maxInput.addEventListener('input', function() {
            maxSlider.value = this.value;
            updatePriceRange();
        });
    }

    // ==================== FILTER EVENT HANDLERS ====================
    $('.category-checkbox').on('change', function() {
        if ($(this).data('handle') === 'all') {
            if ($(this).is(':checked')) {
                $('.category-checkbox').not(this).prop('checked', false);
            }
        } else {
            if ($(this).is(':checked')) {
                $('.category-checkbox[data-handle="all"]').prop('checked', false);
            }
        }
        applyAllFilters();
    });

    $('#in-stock, #out-of-stock').on('change', applyAllFilters);

    // ==================== APPLY FILTERS FUNCTION ====================
    function applyAllFilters() {
        const selectedCategories = [];
        $('.category-checkbox:checked').each(function() {
            selectedCategories.push($(this).data('handle'));
        });

        const showInStock = $('#in-stock').is(':checked');
        const showOutStock = $('#out-of-stock').is(':checked');
        
        const minPrice = parseInt($('#price-slider-min').val()) || 0;
        const maxPrice = parseInt($('#price-slider-max').val()) || 99999;

        $('.product-card').each(function() {
            const $card = $(this);
            const collection = $card.data('collection');
            const price = parseInt($card.data('price'));
            const available = $card.data('available');
            
            // Skip gift-box collection in step 0
            if (collection === 'gift-box' && $('.step.active').data('step') === 0) {
                $card.hide();
                return;
            }

            let showCard = true;

            // Category filter
            if (!selectedCategories.includes('all') && !selectedCategories.includes(collection)) {
                showCard = false;
            }

            // Availability filter
            if (!showInStock && available) showCard = false;
            if (!showOutStock && !available) showCard = false;

            // Price filter
            if (price < minPrice || price > maxPrice) {
                showCard = false;
            }

            $card.toggle(showCard);
        });

        applySearchAndSort();
        updateAvailabilityCount();
    }

    // ==================== UTILITY FUNCTIONS ====================
    // Consistent price parsing function
    function parsePrice(price) {
        if (typeof price === 'string') {
            // Remove currency symbols and parse
            price = price.replace(/[à§³$,]/g, '');
        }
        const parsed = parseFloat(price);
        return isNaN(parsed) ? 0 : Math.round(parsed);
    }

    // Format price for display
    function formatPrice(price) {
        const numPrice = parsePrice(price);
        return `à§³${numPrice}`;
    }

    // ==================== HELPER FUNCTIONS ====================
    function isProductInCart(variantId) {
        return selectedProducts.some(p => p.id === String(variantId));
    }

    function getProductCountInCart(variantId) {
        return selectedProducts.filter(p => p.id === String(variantId)).length;
    }

    // ==================== UPDATE VARIANT UI STATE ====================
    function updateVariantUIState($card, variantId) {
        const productCount = getProductCountInCart(String(variantId));
        const $qtyControl = $card.find('.cus-quantity-control');
        const $addBtn = $card.find('.add-to-box-btn');
        
        if (productCount > 0) {
            // Variant is in cart, show quantity controls
            $qtyControl.html(`
                <button class="cus-qty-btn cus-decrease" data-id="${variantId}">-</button>
                <span class="cus-qty">${productCount}</span>
                <button class="cus-qty-btn cus-increase" data-id="${variantId}">+</button>
            `);
            $qtyControl.css('display', 'flex');
            $addBtn.hide();
        } else {
            // Variant is not in cart, show add button
            $qtyControl.hide();
            $addBtn.show();
        }
    }

    // ==================== INITIALIZE QUANTITY CONTROLS ON PAGE LOAD ====================
    function initializeQuantityControls() {
        $('.product-card').each(function() {
            const $card = $(this);
            const currentVariantId = $card.data('id');
            updateVariantUIState($card, currentVariantId);
        });
    }

    // ==================== RENDER MINI CART ====================
    function renderMiniCart() {
        let cartContainer = $('#box-items');
        let totalPrice = 0;
        cartContainer.empty();

        selectedProducts.forEach((product, index) => {
            const productPrice = parsePrice(product.price);
            totalPrice += productPrice;

            cartContainer.append(`
                <div class="box-item" data-index="${index}">
                    <img src="${product.image}" alt="${product.title}" />
                    <button class="remove-btn" data-index="${index}">Ã—</button>
                </div>
            `);
        });

        const totalItemCount = selectedProducts.length;
        updateBoxCount(totalItemCount, totalPrice);
        $('#box-total').text(formatPrice(totalPrice));
    }

    function updateBoxCount(count, total) {
        const itemLabel = count === 1 ? 'ITEM' : 'ITEMS';
        if (count === 0) {
            $('#mini-cart h3').html(`YOUR BOX (0 ITEM)`);
        } else {
            $('#mini-cart h3').html(`YOUR BOX (<span id="box-count">${count}</span> ${itemLabel})`);
        }
    }

    // ==================== ADD TO BOX ====================
    $(document).on('click', '.add-to-box-btn', function () {
        const $card = $(this).closest('.product-card');
        const hasVariants = parseInt($(this).data('has-variants')) > 0;
        const isAvailable = $card.data('available') === 'true' || $card.data('available') === true;
        
        // Don't allow adding out of stock products
        if (!isAvailable) {
            return;
        }
        
        // ALWAYS show modal if product has variants (removed the cart check)
        if (hasVariants) {
            showVariantModal($card);
            return;
        }
        
        // Otherwise, add directly to cart
        const productId = $card.data('product-id');
        
        let product = {
            id: String($(this).data('id')),
            title: $(this).data('title'),
            image: $(this).data('image'),
            price: parsePrice($(this).data('price')),
            collection: $card.data('collection'),
            productId: productId
        };

        selectedProducts.push(product);
        updateLocalStorageAndUI();
        
        // Update UI state for this variant
        updateVariantUIState($card, product.id);
    });

    // ==================== VARIANT MODAL ====================
    function showVariantModal($card) {
        const variantsData = $card.find('.product-variants-data');
        if (!variantsData.length) return;
        
        const variants = JSON.parse(variantsData.attr('data-variants'));
        const options = JSON.parse(variantsData.attr('data-options'));
        const productTitle = $card.find('.product-title').text();
        const productImage = $card.find('.product-main-image').attr('src');
        const productCollection = $card.data('collection');
        const productId = $card.data('product-id');
        
        // Set modal content
        $('#modal-product-image').attr('src', productImage);
        $('#modal-product-title').text(productTitle);
        
        // Build variant options
        const $optionsContainer = $('#modal-variant-options');
        $optionsContainer.empty();
        
        // Find first available variant as default
        let selectedVariant = variants.find(v => v.available !== false) || variants[0];
        $('#modal-product-price').text(formatPrice(selectedVariant.price));
        $('#modal-product-image').attr('src', selectedVariant.image);
        
        // Create option selectors for each product option
        options.forEach((option, optionIndex) => {
            const optionName = option.name;
            const optionValues = option.values;
            
            const $optionGroup = $('<div class="modal-variant-group"></div>');
            $optionGroup.append(`<label class="modal-option-label">${optionName}:</label>`);
            
            const $buttonGroup = $('<div class="modal-variant-buttons"></div>');
            
            optionValues.forEach(value => {
                // Check if this option value is available in any variant
                const variantWithThisOption = variants.find(v => v.options[optionIndex] === value);
                const isAvailable = variantWithThisOption && variantWithThisOption.available !== false;
                
                const $btn = $(`<button class="modal-variant-btn" data-option-index="${optionIndex}" data-value="${value}" ${!isAvailable ? 'disabled' : ''}>${value}${!isAvailable ? ' (Out of Stock)' : ''}</button>`);
                
                // Set first available option as active
                if (isAvailable && optionIndex === 0 && value === selectedVariant.options[0]) {
                    $btn.addClass('active');
                }
                
                $buttonGroup.append($btn);
            });
            
            $optionGroup.append($buttonGroup);
            $optionsContainer.append($optionGroup);
        });
        
        // Store variants data on modal
        $('#variant-modal').data('variants', variants);
        $('#variant-modal').data('product-collection', productCollection);
        $('#variant-modal').data('product-id', productId);
        $('#variant-modal').data('product-title', productTitle);
        $('#variant-modal').data('selected-variant', selectedVariant);
        
        // Update add button state
        updateModalAddButtonState(selectedVariant);
        
        // Show modal
        $('#variant-modal').fadeIn(300);
        $('body').css('overflow', 'hidden');
    }
    
    // Update modal add to box button based on variant availability
    function updateModalAddButtonState(variant) {
        const $addBtn = $('#modal-add-to-box');
        const isAvailable = variant && variant.available !== false;
        
        if (!isAvailable) {
            $addBtn.prop('disabled', true).text('Out of Stock');
        } else {
            $addBtn.prop('disabled', false).text('Add to Box');
        }
    }
    
    // Close modal handlers
    $('.variant-modal-close, .variant-modal-overlay').on('click', function() {
        $('#variant-modal').fadeOut(300);
        $('body').css('overflow', '');
    });
    
    // Variant selection in modal
    $(document).on('click', '.modal-variant-btn:not(:disabled)', function() {
        const $btn = $(this);
        const optionIndex = parseInt($btn.data('option-index'));
        
        // Toggle active state for this option group
        $btn.siblings().removeClass('active');
        $btn.addClass('active');
        
        // Get all selected options
        const selectedOptions = [];
        $('.modal-variant-btn.active').each(function() {
            selectedOptions[$(this).data('option-index')] = $(this).data('value');
        });
        
        // Find matching variant
        const variants = $('#variant-modal').data('variants');
        const matchingVariant = variants.find(v => {
            return v.options.every((opt, idx) => opt === selectedOptions[idx]);
        });
        
        if (matchingVariant) {
            $('#modal-product-price').text(formatPrice(matchingVariant.price));
            $('#modal-product-image').attr('src', matchingVariant.image);
            $('#variant-modal').data('selected-variant', matchingVariant);
            updateModalAddButtonState(matchingVariant);
        }
    });
    
    // Add to box from modal
    $('#modal-add-to-box').on('click', function() {
        const selectedVariant = $('#variant-modal').data('selected-variant') || $('#variant-modal').data('variants')[0];
        const productCollection = $('#variant-modal').data('product-collection');
        const productId = $('#variant-modal').data('product-id');
        const productTitle = $('#variant-modal').data('product-title');
        
        // Check if variant is available
        if (!selectedVariant.available) {
            return;
        }
        
        let product = {
            id: String(selectedVariant.id),
            title: productTitle + ' - ' + selectedVariant.title,
            image: selectedVariant.image.replace('300x', '200x'),
            price: parsePrice(selectedVariant.price),
            collection: productCollection,
            productId: productId
        };

        selectedProducts.push(product);
        updateLocalStorageAndUI();
        
        // Update UI for all cards with this product
        $(`.product-card[data-product-id="${productId}"]`).each(function() {
            const $card = $(this);
            const cardVariantId = $card.data('id');
            if (String(cardVariantId) === String(selectedVariant.id)) {
                updateVariantUIState($card, selectedVariant.id);
            }
        });
        
        // Close modal
        $('#variant-modal').fadeOut(300);
        $('body').css('overflow', '');
    });

    // ==================== QUANTITY CONTROLS ====================
    function updateQuantityDisplay(id) {
        const count = selectedProducts.filter(p => p.id === id).length;
        $(`.cus-qty-btn[data-id="${id}"]`).siblings('.cus-qty').text(count);
    }

    $(document).on('click', '.cus-qty-btn.cus-decrease', function () {
        const id = $(this).data('id').toString();

        const index = selectedProducts.findIndex(p => p.id === id);
        if (index !== -1) {
            selectedProducts.splice(index, 1);
            updateLocalStorageAndUI();

            const remaining = selectedProducts.filter(p => p.id === id).length;
            
            // Update UI for all cards that have this variant
            $('.product-card').each(function() {
                const $card = $(this);
                const cardVariantId = $card.data('id');
                if (String(cardVariantId) === String(id)) {
                    updateVariantUIState($card, id);
                }
            });

            if (remaining > 0) {
                updateQuantityDisplay(id);
            }
        }
    });

    $(document).on('click', '.cus-qty-btn.cus-increase', function () {
        const id = $(this).data('id').toString();
        
        const product = selectedProducts.find(p => p.id === id);

        if (product) {
            selectedProducts.push({ ...product });
        } else {
            const $card = $(this).closest('.product-card');
            const productId = $card.data('product-id');

            let newProduct = {
                id: id,
                title: $card.find('.add-to-box-btn').data('title'),
                image: $card.find('.add-to-box-btn').data('image'),
                price: parsePrice($card.find('.add-to-box-btn').data('price')),
                collection: $card.data('collection'),
                productId: productId
            };

            selectedProducts.push(newProduct);
        }

        updateLocalStorageAndUI();
        updateQuantityDisplay(id);
    });

    // ==================== REMOVE ITEM FROM BOX ====================
    $(document).on('click', '.remove-btn', function () {
        let index = $(this).data('index');

        const removedProduct = selectedProducts[index];
        const removedId = removedProduct.id;

        selectedProducts.splice(index, 1);
        updateLocalStorageAndUI();

        // Update UI for all cards that might have this variant
        $('.product-card').each(function() {
            const $card = $(this);
            const cardVariantId = $card.data('id');
            if (String(cardVariantId) === String(removedId)) {
                updateVariantUIState($card, removedId);
            }
        });

        const remaining = selectedProducts.filter(p => p.id === removedId).length;
        if (remaining > 0) {
            updateQuantityDisplay(removedId);
        }

        const hasOnlyGiftBox = selectedProducts.length === 1 && selectedProducts[0].collection === 'gift-box';
        const hasNoProduct = selectedProducts.length === 0;

        if (hasOnlyGiftBox || hasNoProduct) {
            if (hasOnlyGiftBox) {
                selectedProducts = [];
                localStorage.removeItem('selectedProducts');
                renderMiniCart();
                renderConfirmation();
            }
            showStep(0);
            return;
        }

        const currentStep = $('.step-indicator .step.active').index();
        const hasGiftBox = selectedProducts.some(p => p.collection === 'gift-box');
        if (currentStep === 2 && !hasGiftBox) {
            showStep(1);
        }
    });

    // ==================== UPDATE LOCAL STORAGE AND UI ====================
    function updateLocalStorageAndUI() {
        localStorage.setItem('selectedProducts', JSON.stringify(selectedProducts));
        renderMiniCart();
        renderConfirmation();
        updateNextButtonState();
        updateConfirmButtonState();
    }

    // ==================== NEXT BUTTON ====================
    if ($('#next-inline-alert').length === 0) {
        $('#next-button').before(`
            <p id="next-inline-alert" style="color: red; font-size: 14px; margin-bottom: 6px; display: none;">
                Please add at least one product.
            </p>
        `);
    }
    
    $('#next-button').click(function () {
        const hasProduct = selectedProducts.some(p => p.collection !== 'gift-box');
        
        if (!hasProduct) {
            $('#next-inline-alert').fadeIn();

            $('.step-indicator .step').removeClass('active completed');
            $('.step-indicator .step').eq(0).addClass('active');

            $('#product-step').show();
            $('#gift-box-step, #confirm-box-step').hide();

            $('.filter-sidebar').show();
            $('.search-sort-header').show();
            applyAllFilters();
            return;
        }

        $('#next-inline-alert').fadeOut();
        showStep(1);
    });

    // ==================== CONFIRM BUTTON ====================
    if ($('#confirm-inline-alert').length === 0) {
        $('#confirm-button').before(`
            <p id="confirm-inline-alert" style="color: red; font-size: 14px; margin-bottom: 8px; display: none;">
                Please select a gift box.
            </p>
        `);
    }

    $('#confirm-button').click(function () {
        let giftBoxCount = selectedProducts.filter(p => p.collection === 'gift-box').length;

        if (giftBoxCount === 0) {
            $('#confirm-inline-alert')
                .text('Please select a gift box.')
                .stop(true, true).fadeIn();

            setTimeout(() => { $('#confirm-inline-alert').fadeOut(); }, 3000);
            return;
        }

        $('#confirm-inline-alert').hide();
        showStep(2);
        renderConfirmation();
    });

    function updateNextButtonState() {
        const hasProduct = selectedProducts.some(p => p.collection !== 'gift-box');
        $('#next-button').prop('disabled', !hasProduct);
    }
    
    function updateConfirmButtonState() {
        const giftBoxCount = selectedProducts.filter(p => p.collection === 'gift-box').length;
        const isValidGiftBoxSelection = giftBoxCount >= 1;
        $('#confirm-button').prop('disabled', !isValidGiftBoxSelection);
    }

    // ==================== BACK BUTTONS ====================
    $('#back-button').click(() => {
        showStep(0);
    });
    
    $('#back-button-2').click(() => showStep(1));

    // ==================== SUBMIT BUTTON ====================
    $('#submit-button').click(function () {
        if (selectedProducts.length === 0) {
            alert('Your box is empty!');
            return;
        }

        let formData = selectedProducts.map(product => ({
            id: product.id,
            quantity: 1
        }));

        $.getJSON('/cart.js', function (cart) {
            let existingBoxNumbers = [];

            cart.items.forEach(item => {
                const boxName = item.properties && item.properties.box_name;
                if (boxName && boxName.startsWith('Box-item')) {
                    const number = parseInt(boxName.replace('Box-item ', ''));
                    if (!isNaN(number)) existingBoxNumbers.push(number);
                }
            });

            const nextBoxNumber = existingBoxNumbers.length > 0
                ? Math.max(...existingBoxNumbers) + 1
                : 1;

            const boxName = `Box-item ${nextBoxNumber}`;
            const updatedFormData = formData.map(item => ({
                ...item,
                properties: {
                    box_name: boxName
                }
            }));

            console.log("ðŸ“¦ Sending to cart:", JSON.stringify({ items: updatedFormData }, null, 2));

            $.ajax({
                type: 'POST',
                url: '/cart/add.js',
                data: JSON.stringify({ items: updatedFormData }),
                contentType: 'application/json',
                dataType: 'json',
                success: function () {
                    localStorage.removeItem('selectedProducts');
                    window.location.href = '/cart';
                },
                error: function (err) {
                    console.error('Error adding to cart:', err.responseText || err);
                    alert('Something went wrong. Please try again.');
                }
            });
        }).fail(function(err) {
            console.error('Error getting cart:', err);
            alert('Something went wrong. Please try again.');
        });
    });

    // ==================== CONFIRMATION RENDER ====================
    function renderConfirmation() {
        const container = $('#confirmation-details');
        container.empty();

        const grouped = {};
        selectedProducts.forEach(product => {
            if (!grouped[product.id]) {
                grouped[product.id] = { ...product, quantity: 1 };
            } else {
                grouped[product.id].quantity += 1;
            }
        });

        Object.values(grouped).forEach(product => {
            const unitPrice = parsePrice(product.price);
            const totalPrice = unitPrice * product.quantity;
            
            container.append(`
                <div class="box-item" data-id="${product.id}">
                    <div class="cus-product-image-wrapper">
                        <img src="${product.image}" alt="${product.title}" />
                        <div class="quantity-control">
                            <span class="qty">${product.quantity}</span>
                        </div>
                    </div>
                    <span>${product.title}</span>
                    <span>${formatPrice(totalPrice)}</span>
                </div>
            `);
        });
    }

    // ==================== PROGRESS BAR ====================
    function updateProgressBar(stepIndex) {
        let percent = stepIndex === 0 ? 33 : stepIndex === 1 ? 66 : 100;
        if ($('#progress-fill').length) {
            $('#progress-fill').css('width', percent + '%');
        }
    }

    // ==================== STEP CONTROL ====================
    function showStep(stepIndex) {
        $('.step-section').hide();

        $('html, body').animate({ scrollTop: 0 }, 400);

        $('.step-indicator .step')
            .removeClass('active completed')
            .each(function (index) {
                if (index < stepIndex) $(this).addClass('completed');
                if (index === stepIndex) $(this).addClass('active');
            });

        $('#next-button, #confirm-button, #back-button, #submit-button, #back-button-2').hide();

        if (stepIndex === 0) {
            $('#product-step').show();
            $('#next-button').show();
            $('.filter-sidebar').show();
            $('.search-sort-header').show();
            applyAllFilters();
        }

        if (stepIndex === 1) {
            $('#gift-box-step').show();
            $('.filter-sidebar').hide();
            $('.search-sort-header').hide();
            $('.product-card').each(function () {
                const collection = $(this).data('collection');
                $(this).toggle(collection === 'gift-box');
            });
            $('#back-button, #confirm-button').show();
        }

        if (stepIndex === 2) {
            $('#back-button-2').show();
            $('#confirm-box-step').show();
            $('#submit-button').show();
            $('.filter-sidebar').hide();
            $('.search-sort-header').hide();
        }

        updateProgressBar(stepIndex);
    }

    // ==================== STEP INDICATOR CLICK ====================
    $(document).on('click', '.step-indicator .step', function () {
        const clickedStep = parseInt($(this).data('step'));
        const currentStep = $('.step-indicator .step.active').index();
        if (clickedStep < currentStep) showStep(clickedStep);
    });

    // ==================== SEARCH & SORT WITH SHOWCASE ====================
    $('#productSearch').on('input', applySearchAndSort);
    $('#sortOptions').on('change', applySearchAndSort);

    function applySearchAndSort() {
        let searchQuery = $('#productSearch').val().toLowerCase();
        let sortOption = $('#sortOptions').val();

        // Handle showcase section
        if (sortOption === 'best-selling' || sortOption === 'featured') {
            handleShowcaseDisplay(sortOption);
        } else {
            $('#showcase-section').hide();
            $('#showcaseGrid').empty();
        }

        // Only sort products in the main grid, not in showcase
        let $products = $('#productGrid .product-card:visible').sort(function (a, b) {
            let priceA = parsePrice($(a).data('price'));
            let priceB = parsePrice($(b).data('price'));
            let titleA = $(a).data('title').toLowerCase();
            let titleB = $(b).data('title').toLowerCase();
            let featuredA = $(a).data('featured') === 'true' || $(a).data('featured') === true;
            let featuredB = $(b).data('featured') === 'true' || $(b).data('featured') === true;
            let bestSellingA = $(a).data('best-selling') === 'true' || $(a).data('best-selling') === true;
            let bestSellingB = $(b).data('best-selling') === 'true' || $(b).data('best-selling') === true;
            let positionA = parseInt($(a).data('position')) || 9999;
            let positionB = parseInt($(b).data('position')) || 9999;
            let collectionIndexA = parseInt($(a).data('collection-index')) || 9999;
            let collectionIndexB = parseInt($(b).data('collection-index')) || 9999;

            if (sortOption === 'manual') {
                // Sort by manual position first, then use collection's natural order
                if (positionA !== positionB) return positionA - positionB;
                // Use collection's default sorting (respects your collection settings)
                return collectionIndexA - collectionIndexB;
            }
            if (sortOption === 'price-asc') return priceA - priceB;
            if (sortOption === 'price-desc') return priceB - priceA;
            if (sortOption === 'title-asc') return titleA.localeCompare(titleB);
            if (sortOption === 'featured') {
                if (featuredA && !featuredB) return -1;
                if (!featuredA && featuredB) return 1;
                return collectionIndexA - collectionIndexB;
            }
            if (sortOption === 'best-selling') {
                if (bestSellingA && !bestSellingB) return -1;
                if (!bestSellingA && bestSellingB) return 1;
                return collectionIndexA - collectionIndexB;
            }
            return collectionIndexA - collectionIndexB;
        });

        // Apply search filter and append back to main grid
        $products.each(function () {
            let title = $(this).data('title').toLowerCase();
            $(this).toggle(title.includes(searchQuery));
        });

        $('#productGrid').append($products);
    }

    // ==================== SHOWCASE DISPLAY HANDLER ====================
    function handleShowcaseDisplay(type) {
        const $showcaseGrid = $('#showcaseGrid');
        const $showcaseSection = $('#showcase-section');
        
        $showcaseGrid.empty();
        
        let showcaseProducts = [];
        let showcaseTitle = type === 'best-selling' ? 'Best Selling Products' : 'Featured Products';
        
        // Only get products from main grid, not from showcase
        $('#productGrid .product-card').each(function() {
            const $card = $(this);
            const collection = $card.data('collection');
            
            // Skip gift-box products
            if (collection === 'gift-box') return;
            
            // Check if product should be showcased
            const isBestSelling = $card.data('best-selling') === 'true' || $card.data('best-selling') === true;
            const isFeatured = $card.data('featured') === 'true' || $card.data('featured') === true;
            
            if ((type === 'best-selling' && isBestSelling) || (type === 'featured' && isFeatured)) {
                // Clone the product card for showcase
                const $clone = $card.clone(true);
                showcaseProducts.push($clone);
            }
        });
        
        if (showcaseProducts.length > 0) {
            $('.showcase-title').text(showcaseTitle);
            showcaseProducts.forEach($product => {
                $showcaseGrid.append($product);
            });
            $showcaseSection.show();
        } else {
            $showcaseSection.hide();
        }
    }

    // ==================== SEARCH SUGGESTIONS ====================
    const productSearch = document.getElementById('productSearch');
    const suggestionsBox = document.getElementById('search-suggestions');

    if (productSearch && suggestionsBox) {
        const productCards = document.querySelectorAll('#productGrid .product-card');
        const productData = Array.from(productCards).map(card => ({
            title: card.querySelector('.product-title')?.textContent?.trim(),
            id: card.getAttribute('data-id')
        })).filter(item => item.title && item.id);

        productSearch.addEventListener('input', function () {
            const query = this.value.toLowerCase().trim();
            suggestionsBox.innerHTML = '';

            if (query.length < 2) {
                suggestionsBox.style.display = 'none';
                return;
            }

            const matches = productData.filter(p => p.title.toLowerCase().includes(query)).slice(0, 6);

            if (matches.length === 0) {
                suggestionsBox.style.display = 'none';
                return;
            }

            matches.forEach(match => {
                const div = document.createElement('div');
                div.textContent = match.title;
                div.dataset.id = match.id;
                div.addEventListener('click', () => {
                    productSearch.value = match.title;
                    suggestionsBox.style.display = 'none';
                    filterProductCards(match.title);
                });
                suggestionsBox.appendChild(div);
            });

            suggestionsBox.style.display = 'block';
        });

        document.addEventListener('click', (e) => {
            if (!e.target.closest('.custom-search-wrapper')) {
                suggestionsBox.style.display = 'none';
            }
        });
    }

    function filterProductCards(query) {
        const cards = document.querySelectorAll('#productGrid .product-card');
        cards.forEach(card => {
            const title = card.querySelector('.product-title')?.textContent?.toLowerCase();
            card.style.display = title && title.includes(query.toLowerCase()) ? 'block' : 'none';
        });
    }

    // ==================== INITIALIZE ON LOAD ====================
    renderMiniCart();
    updateNextButtonState();
    updateConfirmButtonState();
    initializeFilters();
    
    setTimeout(() => {
        $('#sortOptions').val('manual');
        applyAllFilters();
        initializeQuantityControls();
    }, 100);
});
</script>

<style>
/* General Box Section */
.custom-gift-box-section {
  padding: 20px;
  position: relative;
  display: flex;
  flex-wrap: nowrap;
  gap: 20px;
  justify-content: space-between;
  margin-bottom: 20px;
}

/* Main Page Title */
.main-page-title.page-title.h0.scroll-trigger.animate--fade-in {
  margin: 0;
  font-family: 'Garet', sans-serif !important;
  font-weight: bold;
  text-align: center;
}

/* Filter Sidebar Styles */
.filter-sidebar {
  width: 250px;
  background: #f8f9fa;
  border: 1px solid #e9ecef;
  border-radius: 8px;
  padding: 20px;
  position: sticky;
  top: 70px;
  height: fit-content;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.filter-sidebar h3 {
  margin: 0 0 20px 0;
  font-size: 18px;
  font-weight: 600;
  color: #333;
  border-bottom: 1px solid #e9ecef;
  padding-bottom: 10px;
}

.filter-group {
  margin-bottom: 25px;
}

.filter-group h4 {
  margin: 0 0 12px 0;
  font-size: 16px;
  font-weight: 600;
  color: #495057;
}

/* Category Filter */
.category-list {
  display: flex;
  flex-direction: column;
  gap: 8px;
  max-height: 300px;
  overflow: scroll;
}

.category-item {
  display: flex;
  align-items: center;
  cursor: pointer;
  font-size: 14px;
  color: #495057;
  padding: 2px 0;
}

.category-item input[type="checkbox"] {
  margin-right: 8px;
  transform: scale(1.1);
}

.category-item:hover {
  color: #000;
}

/* Availability Filter */
.availability-list {
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.availability-item {
  display: flex;
  align-items: center;
  cursor: pointer;
  font-size: 14px;
  color: #495057;
  padding: 2px 0;
}

.availability-item input[type="checkbox"] {
  margin-right: 8px;
  transform: scale(1.1);
}

.availability-item:hover {
  color: #000;
}

/* Price Filter */
.price-info {
  font-size: 13px;
  color: #6c757d;
  margin-bottom: 15px;
}

.price-inputs {
  display: flex;
  align-items: center;
  gap: 8px;
  margin-bottom: 15px;
}

.price-inputs input {
  width: 80px;
  padding: 8px;
  border: 1px solid #ced4da;
  border-radius: 4px;
  font-size: 14px;
}

.price-inputs span {
  font-size: 14px;
  color: #495057;
}

.price-slider-container {
  position: relative;
  height: 20px;
  margin-bottom: 10px;
}

.price-slider {
  position: absolute;
  width: 100%;
  height: 5px;
  border-radius: 5px;
  background: #ddd;
  outline: none;
  -webkit-appearance: none;
  appearance: none;
}

.price-slider::-webkit-slider-thumb {
  -webkit-appearance: none;
  appearance: none;
  width: 20px;
  height: 20px;
  border-radius: 50%;
  background: #000;
  cursor: pointer;
}

.price-slider::-moz-range-thumb {
  width: 20px;
  height: 20px;
  border-radius: 50%;
  background: #000;
  cursor: pointer;
  border: none;
}

.price-display {
  text-align: center;
  font-size: 14px;
  font-weight: 600;
  color: #495057;
}

/* Content Area */
.content-area {
  flex: 1;
  margin-left: 0;
}

.search-sort-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20px;
  gap: 15px;
}

/* Custom Search Wrapper */
.custom-search-wrapper {
  position: relative;
  flex: 1;
}

#productSearch {
  padding: 10px 40px 10px 12px;
  width: 100%;
  border: 1px solid #ccc;
  border-radius: 6px;
  font-size: 14px;
  box-sizing: border-box;
}

.search-icon-button {
  position: absolute;
  top: 50%;
  right: 12px;
  transform: translateY(-50%);
  background: transparent;
  border: none;
  padding: 0;
  cursor: pointer;
  height: 20px;
  width: 20px;
  display: flex;
  align-items: center;
  justify-content: center;
}

.search-icon-button svg {
  width: 18px;
  height: 18px;
  stroke: #666;
  transition: stroke 0.2s ease;
}

.search-icon-button:hover svg {
  stroke: #000;
}

.suggestions-dropdown {
  position: absolute;
  top: 100%;
  left: 0;
  width: 100%;
  background: #fff;
  border: 1px solid #ddd;
  border-top: none;
  z-index: 10;
  max-height: 200px;
  overflow-y: auto;
  border-radius: 0 0 6px 6px;
  box-shadow: 0 4px 8px rgba(0, 0, 0, 0.06);
}

.suggestions-dropdown div {
  padding: 8px 12px;
  cursor: pointer;
  font-size: 14px;
}

.suggestions-dropdown div:hover {
  background-color: #f8f9fa;
}

.search-sort-header input,
.search-sort-header select {
  padding: 10px;
  border-radius: 6px;
  border: 1px solid #ccc;
  background: #fff;
  width: 32%;
}

/* Showcase Section */
.showcase-section {
  margin-bottom: 40px;
  padding-bottom: 30px;
  border-bottom: 2px solid #e9ecef;
}

.showcase-title {
  font-size: 24px;
  font-weight: 700;
  margin-bottom: 20px;
  color: #000;
  font-family: 'Garet', sans-serif;
}

.showcase-grid {
  margin-bottom: 0 !important;
}

/* Product Badges */
.product-badge {
  position: absolute;
  top: 10px;
  right: 10px;
  padding: 4px 12px;
  font-size: 11px;
  font-weight: 600;
  text-transform: uppercase;
  border-radius: 4px;
  z-index: 2;
  letter-spacing: 0.5px;
}

.featured-badge {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
}

.bestseller-badge {
  background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
  color: white;
}

/* Out of Stock Badge */
.outofstock-badge {
  background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
  color: white;
}

/* Step Indicator */
.step-indicator {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  gap: 1rem;
  position: relative;
  width: 50vw;
  margin: 0 auto;
  padding-bottom: 50px;
}

.step {
  display: flex;
  flex-direction: column;
  align-items: center;
  text-align: center;
  position: relative;
  flex: 1;
  font-family: sans-serif;
  color: #9ca3af;
  cursor: pointer;
}

.step:not(:last-child)::after {
  content: "";
  position: absolute;
  top: 16px;
  left: 50%;
  width: 100%;
  height: 2px;
  transform: translateX(0%);
  border-top: 2px dotted #d1d5db;
  z-index: 0;
}

.step-indicator .step-number {
  border-radius: 50%;
  padding: 5px 15px;
  border: 1px solid #aaa;
  z-index: 1;
  background: #fff;
}

.step-number {
  width: 32px;
  height: 32px;
  border-radius: 50%;
  background-color: #e5e7eb;
  color: #374151;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: 600;
  z-index: 1;
  font-size: 14px;
}

.step.completed .step-number,
.step.active .step-number {
  background-color: #000;
  color: white;
  border-radius: 50%;
  padding: 5px 15px;
  border: #000;
}

.step span:last-child {
  margin-top: 6px;
  font-size: 14px;
}

.step.completed span:last-child,
.step.active span:last-child {
  font-weight: 600;
  color: #000;
}

.step.completed:not(:last-child)::after {
  border-top: 2px solid #000;
}

.step::after {
  transition: border-top-color 0.4s ease;
}

.step-content-wrapper {
  width: 100%;
}

/* Product Grid */
.product-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
  gap: 15px;
}

/* Product Card with Same Size */
.product-card {
  background: #fff;
  border: 1px solid #ddd;
  padding: 15px;
  text-align: center;
  border-radius: 8px;
  box-sizing: border-box;
  display: flex;
  flex-direction: column;
  justify-content: space-between;
  transition: box-shadow 0.2s ease;
  position: relative;
}

.product-card:hover {
  box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}

.product-card img {
  width: 100%;
  height: 180px;
  object-fit: cover;
  border-radius: 6px;
  margin-bottom: 10px;
}

.product-card p {
  display: -webkit-box;
  -webkit-line-clamp: 2;
  -webkit-box-orient: vertical;
  overflow: hidden;
  text-overflow: ellipsis;
  text-align: center;
  max-height: calc(1.2em * 2);
  line-height: 1.2em;
}

.product-title {
  font-weight: 600;
  margin: 8px 0;
  color: #000;
}

.product-price {
  font-size: 16px;
  font-weight: 600;
  color: #000;
  margin-bottom: 10px;
}

/* Variant Options */
.variant-values {
  display: flex;
  gap: 8px;
  margin-bottom: 10px;
  justify-content: center;
  flex-wrap: wrap;
}

.variant-option-btn {
  padding: 6px 14px;
  border: 1px solid #ccc;
  border-radius: 9999px;
  background: white;
  color: #333;
  cursor: pointer;
  font-size: 14px;
  transition: 0.2s ease;
}

.variant-option-btn.active,
.variant-option-btn:hover {
  background: #000;
  color: white;
  border: 1px solid #ccc;
}

/* Variant Modal */
.variant-modal {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  z-index: 9999;
  display: flex;
  align-items: center;
  justify-content: center;
}

.variant-modal-overlay {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.6);
  z-index: 1;
}

.variant-modal-content {
  position: relative;
  background: white;
  border-radius: 12px;
  max-width: 600px;
  width: 90%;
  max-height: 90vh;
  overflow-y: auto;
  z-index: 2;
  box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
}

.variant-modal-close {
  position: absolute;
  top: 15px;
  right: 15px;
  background: #f5f5f5;
  border: none;
  width: 36px;
  height: 36px;
  border-radius: 50%;
  font-size: 24px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: background 0.2s ease;
  z-index: 3;
  color: #333;
  line-height: 1;
}

.variant-modal-close:hover {
  background: #e0e0e0;
}

.variant-modal-body {
  display: flex;
  flex-direction: column;
  padding: 20px;
}

.variant-modal-image {
  width: 100%;
  margin-bottom: 20px;
}

.variant-modal-image img {
  width: 100%;
  height: auto;
  max-height: 350px;
  object-fit: cover;
  border-radius: 8px;
}

.variant-modal-details h3 {
  font-size: 22px;
  font-weight: 700;
  margin: 0 0 10px 0;
  color: #000;
}

.modal-product-price {
  font-size: 20px;
  font-weight: 600;
  color: #000;
  margin-bottom: 20px;
}

.modal-variant-group {
  margin-bottom: 20px;
}

.modal-option-label {
  display: block;
  font-size: 14px;
  font-weight: 600;
  margin-bottom: 10px;
  color: #333;
}

.modal-variant-buttons {
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
}

.modal-variant-btn {
  padding: 10px 20px;
  border: 2px solid #ddd;
  border-radius: 6px;
  background: white;
  color: #333;
  cursor: pointer;
  font-size: 14px;
  font-weight: 500;
  transition: all 0.2s ease;
}

.modal-variant-btn:hover {
  border-color: #000;
}

.modal-variant-btn.active {
  background: #000;
  color: white;
  border-color: #000;
}

/* Disabled variant buttons */
.modal-variant-btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
  background: #f5f5f5;
  color: #999;
  border-color: #ddd;
}

.modal-variant-btn:disabled:hover {
  border-color: #ddd;
  background: #f5f5f5;
}

.modal-add-btn {
  width: 100%;
  background: #000;
  color: white;
  padding: 15px;
  border: none;
  border-radius: 8px;
  font-size: 16px;
  font-weight: 600;
  cursor: pointer;
  margin-top: 10px;
  transition: background 0.3s ease;
}

.modal-add-btn:hover {
  background: #333;
}

/* Disabled add to box button in modal */
#modal-add-to-box:disabled {
  opacity: 0.5;
  background-color: #ccc !important;
  color: #888 !important;
  cursor: not-allowed !important;
}

@media (min-width: 768px) {
  .variant-modal-body {
    flex-direction: row;
    padding: 30px;
    gap: 30px;
  }
  
  .variant-modal-image {
    width: 45%;
    margin-bottom: 0;
  }
  
  .variant-modal-details {
    flex: 1;
  }
}

/* Quantity Controls */
.cus-product-image-wrapper {
  position: relative;
}

.quantity-control {
  position: absolute;
  top: -2px;
  right: -9px;
  line-height: 0;
}

span.qty {
  padding: 2px 6px;
  background-color: #bdbdbd;
  border-radius: 50%;
}

.cus-quantity-control {
  display: flex;
  align-items: center;
  justify-content: space-around;
  gap: 16px;
  border: 1px solid #000;
  border-radius: 5px;
  padding: 4px 0px;
  width: 100%;
  font-size: 14px;
  margin-top: 8px;
  color: #000;
}

.cus-quantity-control button {
  background: transparent;
  border: none;
  font-size: 20px;
  font-weight: bold;
  cursor: pointer;
  color: #000;
}

.cus-qty {
  min-width: 20px;
  text-align: center;
}

/* Add to Box Button */
.add-to-box-btn {
  position: relative;
  background: transparent;
  color: #000;
  font-size: 18px;
  font-weight: 600;
  border: 1px solid #e1e1e1;
  border-radius: 6px;
  cursor: pointer;
  overflow: hidden;
  transition: all 0.3s ease;
  z-index: 0;
  padding: 12px 0;
}

.add-to-box-btn::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  width: 150%;
  height: 100%;
  background: linear-gradient(90deg, rgba(255, 255, 255, 0) 50%, rgba(255, 255, 255, 0.4) 70%, rgba(255, 255, 255, 0) 80%);
  transform: translateX(-100%);
  z-index: 1;
  pointer-events: none;
}

.add-to-box-btn:hover::before {
  animation: smooth-shine 2s ease-in-out infinite;
}

.add-to-box-btn:hover {
  color: #fff;
  background: #000;
  border-color: #000;
}

.add-to-box-btn > * {
  position: relative;
  z-index: 2;
}

/* Disabled add button on product card */
.add-to-box-btn:disabled {
  opacity: 0.5;
  background-color: #ccc !important;
  color: #888 !important;
  cursor: not-allowed !important;
  border-color: #aaa !important;
}

.add-to-box-btn:disabled:hover {
  background-color: #ccc !important;
  color: #888 !important;
}

.add-to-box-btn:disabled::before {
  display: none;
}

@keyframes smooth-shine {
  0% { transform: translateX(-100%); }
  50% { transform: translateX(100%); }
  100% { transform: translateX(100%); }
}

/* Mini Cart (Right Sidebar) */
.your-box {
  position: sticky;
  top: 70px;
  width: 350px;
  background: #fff;
  border: 1px solid #ddd;
  padding: 15px;
  border-radius: 8px;
  z-index: 3;
  box-shadow: 0px 2px 10px rgba(0, 0, 0, 0.1);
  transition: top 0.3s ease;
  height: fit-content;
}

.your-box h3 {
  margin: 0 0 10px 0;
  font-size: 18px;
  font-weight: 600;
  color: #000;
}

.your-box hr {
  margin: 10px 0;
}

.your-box p {
  display: flex;
  justify-content: space-between;
  color: #000;
}

/* Box Item */
.box-item {
  display: flex;
  align-items: center;
  margin-bottom: 12px;
  padding: 10px;
  border-radius: 6px;
  position: relative;
  justify-content: space-between;
  gap: 10px;
}

.box-item img {
  width: 75px;
  height: 75px;
  object-fit: cover;
  border-radius: 4px;
}

.box-item span {
  flex: 1;
  font-size: 14px;
  color: #000;
}

.box-item span:last-child {
  font-weight: 600;
  text-align: right;
  white-space: nowrap;
}

/* Remove Button */
.remove-btn {
  background: #fff;
  border: none;
  font-size: 16px;
  color: #e74c3c;
  cursor: pointer;
  position: absolute;
  border-radius: 50%;
  top: 0px;
  right: 0px;
  border: 1px solid #ddd;
  width: 24px;
  height: 24px;
  display: flex;
  align-items: center;
  justify-content: center;
}

/* Button Styles */
#back-button, #confirm-button, #submit-button, #back-button-2 {
  display: none;
}

.next-btn:disabled,
.confirm-btn:disabled,
.back-btn:disabled,
#submit-button:disabled,
#next-button:disabled,
#confirm-button:disabled {
  opacity: 0.5;
  background-color: #ccc !important;
  color: #888 !important;
  cursor: not-allowed !important;
  pointer-events: none;
  border-color: #aaa !important;
}

.next-btn,
.confirm-btn,
.back-btn,
#submit-button {
  width: 100%;
  background-color: #000;
  color: #fff;
  padding: 12px 16px;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  transition: background-color 0.3s ease;
  border: 1px solid #000;
  font-size: 16px;
  font-weight: 600;
}

.next-btn:hover,
.confirm-btn:hover,
.back-btn:hover,
#submit-button:hover {
  background-color: #333;
}

/* Button Container */
div#box-items-button {
  display: flex;
  gap: 10px;
  flex-direction: row;
  margin-top: 10px;
}

div#box-items {
  display: flex;
  flex-direction: row;
  flex-wrap: wrap;
  gap: 10px;
}

.alert-row {
  margin-top: 10px;
}

/* Confirmation Details Section */
#confirmation-details {
  display: flex;
  flex-direction: column;
  gap: 12px;
  margin-top: 20px;
}

/* Step Headers */
#gift-box-step h2,
.step-section h2,
.step-content-wrapper h2 {
  margin-top: 0 !important;
  transform: translateY(0px) !important;
  font-family: 'Garet', sans-serif !important;
  font-weight: bold;
  margin-bottom: 20px;
}

.your-customize-box .page-width--narrow {
  text-align: center;
}

.qty-btn:disabled {
  opacity: 0.4;
  cursor: not-allowed;
}

.cmb-Price, .cmb-Availability, .cmb-sortOptions{
    display: block;
  }

/* Mobile Responsive Styles */
@media (max-width: 1200px) {
  .cmb-Price, .cmb-Availability, .cmb-sortOptions{
    display: none;
  }
  .custom-gift-box-section {
    flex-direction: column;
  }
  
  .filter-sidebar {
    width: 100%;
    position: relative;
    top: 0;
    margin-bottom: 20px;
  }
  
  .content-area {
    margin-left: 0;
  }
  
  .your-box {
    position: fixed;
    width: 100%;
    bottom: 0;
    left: 0;
    top: unset;
    height: fit-content;
    background: rgb(255, 255, 255);
    border: 1px solid #ddd;
    padding: 15px;
    border-radius: 8px;
    z-index: 1;
    box-shadow: 0px 2px 10px rgba(0, 0, 0, 0.1);
  }

  .step-indicator {
    width: 100vw;
  }

  div#box-items {
    display: flex;
    flex-direction: row;
    flex-wrap: nowrap;
    gap: 10px;
    overflow: auto;
  }
}

@media (max-width: 768px) {
  .step-indicator {
    text-align: center;
    gap: 10px;
    align-items: unset !important;
    width: 95vw;
  }

  .custom-gift-box-section {
    flex-direction: column;
    align-items: center;
    padding: 10px;
    display: block;
  }

  .search-sort-header {
    flex-direction: column;
    gap: 10px;
  }

  .product-grid {
    grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
  }

  .product-card {
    max-width: 100%;
  }

  .product-card img {
    height: auto;
    max-height: 180px;
  }

  .step-indicator {
    text-align: center;
    align-items: center;
    gap: 10px;
  }

  #confirmation-details .box-item {
    align-items: flex-start;
  }

  .box-item {
    flex-direction: row;
  }

  .box-item img {
    width: 40px;
    height: 40px;
  }

  .box-item span {
    flex: unset;
    width: 100%;
    text-align: left;
  }

  .remove-btn {
    top: 0px;
    right: 0px;
  }

  .custom-search-wrapper {
    width: 100% !important;
  }
}

@media (min-width: 769px) and (max-width: 991px) {
  .custom-gift-box-section {
    display: block !important;
  }
}

@media (min-width: 1360px) {
  .back-btn {
    display: none !important;
  }
}
</style>

{% schema %}
{
  "name": "Custom Gift Box",
  "tag": "section",
  "class": "section",
  "blocks": [
    {
      "type": "collection",
      "name": "Collection",
      "settings": [
        {
          "type": "collection",
          "id": "collection",
          "label": "Select Collection"
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "Custom Gift Box",
      "blocks": [
        {
          "type": "collection"
        }
      ]
    }
  ]
}
{% endschema %}
